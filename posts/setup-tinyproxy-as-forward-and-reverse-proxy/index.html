<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Isabel Costa is a software engineer from Portugal, who really likes Open Source, Freecell, Clash of Clans, and much more."><link rel="shortcut icon" href=https://isabelcosta.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>How I set up Tinyproxy as a forward proxy and reverse proxy</title></head><body><header id=banner><h2><a href=https://isabelcosta.github.io/>Isabel Costa</a></h2><nav><ul><li><a href=/about/ title=about>about</a></li><li><a href=/posts/ title=posts>posts</a></li><li><a href=/talks/ title=talks>talks</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>How I set up Tinyproxy as a forward proxy and reverse proxy</h1><div><time>September 6, 2018</time></div></header><p><a href=https://tinyproxy.github.io/>Tinyproxy</a> is a light-weight HTTP/HTTPS proxy daemon for POSIX operating systems, which is <a href=https://github.com/tinyproxy/tinyproxy>open source on Github</a>.</p><p>I tried out this tool to set up a <a href=https://en.wikipedia.org/wiki/Proxy_server>forward proxy</a> on the client side of the communication and a <a href=https://en.wikipedia.org/wiki/Reverse_proxy>reverse proxy</a> on the server side. I wanted to use this so that I could do experiments on the network between the forward proxy and reverse proxy, without the client and server’s involvement.</p><p>Reverse proxies are mostly used as a load balancer, where we connect with a reverse proxy which then decides to which machine it should send the request.</p><blockquote><p>“(…) With reverse proxying it’s possible to make a number of sites appear as if they were part of a single site (…)”</p></blockquote><p>from the manual of the configuration file of Tinyproxy.</p><h2 id=requirements>Requirements</h2><p>The following requirements represent what I used in my experiment:</p><ul><li>An image with a Linux OS distribution — I used a <a href=https://www.debian.org/>Debian</a> GNU/Linux 8.9 (Jessie);</li><li>4 virtual machines to serve as client, forward proxy, reverse proxy and server — I used <a href=https://www.virtualbox.org/>VirtualBox</a> to run these machines, with the Debian’s OS image;</li><li>The server has to run a Web Server — I used <a href=https://httpd.apache.org/>Apache HTTP server</a>, to return the default HTML page saying “It works!”;</li><li>The client has to have a browser or a command-line tool installed such as <a href=https://curl.haxx.se/>curl</a>, to do HTTP requests;</li><li>The forward and reverse proxy machines should have <a href=https://tinyproxy.github.io/>tinyproxy</a> installed — Next I’ll show how to install it on the Debian machines. The version I used was 1.8.3.</li></ul><h2 id=test-architecture>Test architecture</h2><p><img src=/images/tinyproxy-trial-architecture.png alt="Test architecture for the experiment"></p><p>I created <a href=https://github.com/isabelcosta/testing-tiny-proxy>isabelcosta/testing-tiny-proxy</a> repository on Github with the configuration files needed to run both roles of forward proxy and reverse proxy.</p><h2 id=network-configuration>Network Configuration</h2><p>VirtualBox lets you configure the network settings of the virtual machines. I used Nat Network setting which allowed me to have all the machines within the same network. These were the IP assigned to each machine.</p><ul><li>Client — 10.0.2.33</li><li>Forward Proxy — 10.0.2.35</li><li>Reverse Proxy — 10.0.2.36</li><li>Server — 10.0.2.34</li></ul><p>These IP addresses will be important, because they will appear in the examples of how to test the system.</p><h2 id=install-tinyproxy>Install Tinyproxy</h2><p>To install Tinyproxy, you have to type the following command into the forward and reverse proxy machines’s terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt-get install tinyproxy
</span></span></code></pre></div><h2 id=setting-up-the-system>Setting up the system</h2><p>Tinyproxy works according to configuration files. I wrote two configurations, one for the forward proxy and another for the reverse proxy.</p><p><strong>Forward proxy configuration files:</strong></p><pre tabindex=0><code>## forwardproxy.conf -- tinyproxy daemon configuration file

User nobody
Group nogroup

Port 8888
Listen 10.0.2.35
BindSame yes

Timeout 600

DefaultErrorFile &#34;/usr/share/tinyproxy/default.html&#34;
StatFile &#34;/usr/share/tinyproxy/stats.html&#34;
Logfile &#34;/var/log/tinyproxy/tinyproxy.log&#34;
#Syslog On
LogLevel Info
PidFile &#34;/var/run/tinyproxy/tinyproxy.pid&#34;

# Comment to use only the forward proxy
# Uncomment to forward the traffic to the reverse proxy
#Upstream 10.0.2.36:8888

MaxClients 100
MinSpareServers 2
MaxSpareServers 5
StartServers 2
MaxRequestsPerChild 0

Allow 127.0.0.1
Allow 10.0.2.0/24

ViaProxyName &#34;tinyproxy1&#34;

ConnectPort 8888
ConnectPort 80

# The following two ports are used by SSL.
ConnectPort 443
ConnectPort 563
</code></pre><p><strong>Reverse proxy configuration files:</strong></p><pre tabindex=0><code>## reverseproxy.conf -- tinyproxy daemon configuration file

User nobody
Group nogroup

Port 8888
Listen 10.0.2.36

BindSame yes
Timeout 600

StatFile &#34;/usr/share/tinyproxy/stats.html&#34;
Logfile &#34;/var/log/tinyproxy/tinyproxy.log&#34;
#Syslog On
LogLevel Info
PidFile &#34;/var/run/tinyproxy/tinyproxy.pid&#34;

MaxClients 5
MinSpareServers 2
MaxSpareServers 5
StartServers 2

MaxRequestsPerChild 0

Allow 127.0.0.1
Allow 10.0.2.0/24
Allow 10.0.2.35

ViaProxyName &#34;tinyproxy2&#34;

ConnectPort 8888
ConnectPort 80

# The following two ports are used by SSL.
ConnectPort 443
ConnectPort 563

ReversePath &#34;/test/&#34; &#34;http://10.0.2.34:80/&#34;
#ReversePath &#34;/&#34; &#34;http://10.0.2.34:80/&#34;
ReversePath &#34;/wired/&#34; &#34;http://www.wired.com/&#34;

ReverseOnly Yes
ReverseMagic Yes
ReverseBaseURL &#34;http://10.0.2.36:8888/&#34;
</code></pre><p>To run tinyproxy with a specific configuration just do the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tinyproxy -c &lt;configuration-file&gt;
</span></span></code></pre></div><p>E.g.: <code>tinyproxy -c forwardproxy.conf</code></p><h2 id=testing-the-system>Testing the system</h2><p>First make sure that the server is running accordingly and you can access the server with the following command, from any of the machines, since all of them are in the same network. You can test this using <a href=https://curl.haxx.se/>curl</a> command line tool or on a browser:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://10.0.2.34:80/ 
</span></span></code></pre></div><p>Now to test the whole system, if you want to use curl you can type this on the client machine console:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -v --proxy http://10.0.2.35:8888 http://10.0.2.36:8888/
</span></span></code></pre></div><p>This is the output of the previous command:</p><pre tabindex=0><code>root@debian:/home/debian# curl -v --proxy http://10.0.2.35:8888 http://10.0.2.36:8888
* Rebuilt URL to: http://10.0.2.36:8888/
* Hostname was NOT found in DNS cache
*   Trying 10.0.2.35...
* Connected to 10.0.2.35 (10.0.2.35) port 8888 (#0)
&gt; GET http://10.0.2.36:8888/ HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: 10.0.2.36:8888
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Via: 1.0 tinyproxy2 (tinyproxy/1.8.3), 1.1 tinyproxy1 (tinyproxy/1.8.3)
&lt; Last-Modified: Mon, 11 Jun 2007 18:53:14 GMT
&lt; Date: Tue, 12 Dec 2017 23:01:37 GMT
&lt; Content-Type: text/html
&lt; ETag: &#34;2d-432a5e4a73a80&#34;
&lt; Set-Cookie: yummy_magical_cookie=/; path=/
* Server Apache/2.4.29 (Unix) is not blacklisted
&lt; Server: Apache/2.4.29 (Unix)
&lt; Content-Length: 45
&lt; Accept-Ranges: bytes
&lt; 
&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
* Connection #0 to host 10.0.2.35 left intact
</code></pre><p>Another way to see that this is working, is by using <a href=https://www.wireshark.org/>Wireshark</a> tool. This tool allows you to see network traffic. Before testing the system start running Wireshark. By testing in a local network you can see the whole traffic from the client to the server. After requesting and receiving the response from the server, if you filter the Wireshark captures by “http”, you should see a result similar to the following image.</p><p><img src=/images/tinyproxy-trial-wireshark.png alt="Wireshark capture of the communication between the client and the server, passing through the proxies."></p><p>In this <a href=https://www.wireshark.org/>Wireshark</a> capture you can see the traffic in both directions: client ↔ forward proxy ↔ reverse proxy ↔ server.</p><p>To check log file and the forward and reverse proxies, you can type the following on either the machines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /var/log/tinyproxy/tinyproxy.log
</span></span></code></pre></div><p>If you want to test this in another way you can change the proxies’ configuration files on <a href=https://github.com/isabelcosta/testing-tiny-proxy>isabelcosta/testing-tiny-proxy</a> repository.</p><h2 id=tips--notes>Tips & Notes</h2><ul><li>If you want to set up other paths you can do it with the “ReversePath” keyword. E.g.: ReversePath “/test” “http://10.0.2.34:80/” — in this way you can access the server by typing “http://10.0.2.36:8888/test”</li><li>I was always getting the error 400 Bad Request, because I was using this tool in the wrong way. I was using curl to connect with the server as the endpoint instead of the reverse proxy. The reverse proxy does not work as a forward proxy, so don’t use the “upstream” keyword to forward the traffic to the reverse proxy.</li></ul></article></main><footer id=footer>Copyright © Isabel Costa</footer></body></html>